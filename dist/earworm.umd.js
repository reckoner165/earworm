!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Earworm=t()}(this,function(){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function e(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}var o=function(){function i(e,t){r(this,i);var n=window.AudioContext||window.webkitAudioContext;this._audioContext=new n,this._analyser=this._audioContext.createAnalyser(),this.audioElement=e,this._source=this._audioContext.createMediaElementSource(this.audioElement),this._source.connect(this._analyser),this._analyser.connect(this._audioContext.destination),this._analyser.smoothingTimeConstant=t.smoothingTimeConstant,this._analyser.fftSize=t.fftSize}return e(i,[{key:"_computeThreeBandFrequency",value:function(e){for(var t={low:0,mid:0,high:0},n=0;n<11;n++)t.low+=e[n];t.low/=11;for(var i=11;i<22;i++)t.mid+=e[i];t.mid/=11;for(var r=22;r<32;r++)t.high+=e[r];return t.high/=10,t}},{key:"_getAverageVolume",value:function(e){for(var t=0,n=0;n<e.length;n++)t+=e[n];return t/=e.length}},{key:"audioBaseData",get:function(){return{currentTime:this.currentTime,timeDomain:this.timeDomainByteData,allFrequencies:this.freqByteData,threeBand:this.threeBandLevels,volumeStats:this.volumeStats}}},{key:"currentTime",get:function(){return this.audioElement.currentTime}},{key:"timeDomainByteData",get:function(){var e=new Uint8Array(this._analyser.fftSize);return this._analyser.getByteTimeDomainData(e),e}},{key:"freqByteData",get:function(){var e=new Uint8Array(this._analyser.frequencyBinCount);return this._analyser.getByteFrequencyData(e),e}},{key:"threeBandLevels",get:function(){return this._computeThreeBandFrequency(this.freqByteData)}},{key:"volumeStats",get:function(){return{avgVolume:this._getAverageVolume(this.freqByteData),minVolume:this._analyser.minDecibels,maxVolume:this._analyser.maxDecibels}}}]),i}();function a(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[];if(0===e.length)return 0;for(var n=0,i=0,r=0;r<e.length;r++){var o=t[r]||1;i+=o,n+=e[r]*o}return n/i}function s(e){e.sort(function(e,t){return e-t});var t=Math.floor(e.length/2);return e.length%2?e[t]:(e[t-1]+e[t])/2}function u(u){var d={};return(u=u||{}).on=function(e,t){for(var n=0,i=(e=[].concat(e)).length;n<i;n++){var r=e[n];if(!r)throw Error("Tried to listen for an undefined event.");d[r]||(d[r]=[]),d[r].push(t)}return u},u.once=function(e,t){function n(){t.apply(u.off(e,n),arguments)}return n.handler=t,u.on(e,n)},u.off=function(e,t){for(var n=0,i=(e=[].concat(e)).length;n<i;n++){var r=e[n];if(!r)throw Error("Tried to remove an undefined event.");if(r in d){var o=d[r].indexOf(t);if(-1===o){for(var s=0,a=d[r].length;s<a;s++)if(d[r][s].handler===t){o=n;break}if(-1===o)return u}d[r].splice(o,1)}}return u},u.fire=function(e){if(!e)throw Error("Tried to fire an undefined event.");if(e in d)for(var t=d[e].slice(0),n=0,i=t.length;n<i;n++)t[n].apply(u,t.slice.call(arguments,1));return u},u}var d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},h=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},c=function(){function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}}(),v=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var n=[],i=!0,r=!1,o=void 0;try{for(var s,a=e[Symbol.iterator]();!(i=(s=a.next()).done)&&(n.push(s.value),!t||n.length!==t);i=!0);}catch(e){r=!0,o=e}finally{try{!i&&a.return&&a.return()}finally{if(r)throw o}}return n}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},g=[],y=[],f=[],k=[],_=function(){function m(){var e=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},n=t.retryCount,i=void 0===n?3:n,r=t.parallel,o=void 0===r?1:r,s=t.includeWithSpeeds,a=void 0===s||s;h(this,m),this._queue=[],this._activeXhrRequests=new Set,this._retries=new WeakMap,this._retryCount=i,this._processingQueue=this._running=!1,this._parallel=o,this._includeWithSpeeds=a,this._pendingFetchMap=new WeakMap,u(this),window.addEventListener("online",function(){e.start()}),window.addEventListener("offline",function(){e.stop(),e.abort()})}return c(m,null,[{key:"getPercentileSpeed",value:function(){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:.8;return function(e,t){if(e.sort(),0===e.length)return 0;if(t<=0)return e[0];if(1<=t)return e[e.length-1];var n=e.length*t,i=Math.floor(n),r=i+1,o=n%1;return r<e.length?e[i]*(1-o)+e[r]*o:e[i]}(g.slice(-(0<arguments.length&&void 0!==arguments[0]?arguments[0]:5)),e)}},{key:"getAverageSpeed",value:function(){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[];return a(g.slice(-(0<arguments.length&&void 0!==arguments[0]?arguments[0]:5)),e)}},{key:"getMedianSpeed",value:function(){return s(g.slice(-(0<arguments.length&&void 0!==arguments[0]?arguments[0]:5)))}},{key:"getResponseSpeeds",value:function(){return g}},{key:"getProgressSpeeds",value:function(){return k}},{key:"getAverageBitrate",value:function(){for(var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1/0,t=m.getTime()-e,n=[],i=[],r=k.length-1;0<=r;r--){var o=k[r];if(o.startTime<t)break;n.push(o.bitrate)}for(var s=0;s<n.length;s++)i.push(n.length-s);return a(n,i)}},{key:"getFailedSegments",value:function(){return y}},{key:"getSuccessfulSegments",value:function(){return f}},{key:"getTime",value:function(){return"undefined"!=typeof performance?performance.now():(new Date).getTime()}},{key:"calculateExponentialBackoff",value:function(e){return 500*Math.pow(2,e)+Math.round(1e3*Math.random())}}]),c(m,[{key:"add",value:function(e,t,n){return this._addSegmentToQueue(e,t,n),this._running&&!this._processingQueue&&this._processQueue(),this}},{key:"start",value:function(){return this._running||(this._running=!0,this._processQueue()),this}},{key:"stop",value:function(){return this._running=!1,this}},{key:"abort",value:function(){var i=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;this._queue.filter(function(e){return!t||t===e[0].stream}).forEach(function(e){var t=i._getIdentifierFromData(e),n=v(t,3);i.fire("downloadabort",n[2])}),this._queue=this._queue.filter(function(e){return t&&t!==e[0].stream}),this._activeXhrRequests.forEach(function(e){t&&t!==e.stream||e.abort()})}},{key:"_insertAtPosition",value:function(e,t){for(var n=0;n<this._queue.length;n++){if(e.priority<this._queue[n][0].priority)break}this._queue.splice(n,0,[e,t])}},{key:"_addSegmentToQueue",value:function(e,t,n){e.hasOwnProperty("priority")?this._insertAtPosition(e,t):this._queue[n?"unshift":"push"]([e,t])}},{key:"_processQueue",value:function(){if(this._running){this._processingQueue=!0;for(var e=this._parallel-this._activeXhrRequests.size,t=0;t<e;t++)this._fetchOne()}}},{key:"_retry",value:function(e,t,n){var i=this,r=t[0],o=t[1];if(this._retries.get(r)||this._retries.set(r,0),this._retries.set(r,this._retries.get(r)+1),this._retries.get(r)>this._retryCount)this._handleDownloadError(n,e.status,e.data.url,e.data.duration);else{var s=m.calculateExponentialBackoff(this._retries.get(r));console.info("Retrying",r,"after",s,"ms"),setTimeout(function(){i.add(r,o,!0)},s)}}},{key:"_handleXHRResponse",value:function(e,t,n,i){var r;e.status<500||600<=e.status?e.status<400||500<=e.status?(this.fire("downloadend",n,{headers:(r=e.getAllResponseHeaders(),r?r.split("\n").reduce(function(e,t){var n=t.indexOf(":"),i=t.substring(0,n),r=t.substring(n+1);return void 0!==i&&void 0!==r&&(e[i.trim().toLowerCase()]=r.trim()),e},{}):{})}),f.push({url:e.data.url,status:e.status,duration:e.data.duration}),i.call(this,new Uint8Array(e.response))):this._handleDownloadError(n,e.status,e.data.url,e.data.duration):this._retry(e,t,n)}},{key:"_handleDownloadError",value:function(e,t,n,i){y.push({url:n,status:t,duration:i}),this.fire("downloaderror",e,t)}},{key:"_getIdentifierFromData",value:function(e){var t=e[0],n=t;return t.id&&(n=t.id),[t.url,t.byteRange,n,e[1]]}},{key:"_continueProcessingQueue",value:function(){0!==this._activeXhrRequests.size||0!==this._queue.length?this._activeXhrRequests.size<this._parallel&&this._processQueue():this._processingQueue=!1}},{key:"_fetchOne",value:function(){var o=this;if(0!==this._queue.length){var s=null,a=this._queue.shift(),e=this._getIdentifierFromData(a),t=v(e,4),n=t[0],i=t[1],u=t[2],d=t[3],h=a[0].includeWithBandwidthChecks,c=m.getTime(),f=new XMLHttpRequest;f.stream=a[0].stream,f.data={},f.data.url=n;var l=0,_=m.getTime(),p=0;f.addEventListener("progress",function(e){if(e.lengthComputable){var t=8*(e.loaded-l),n=m.getTime(),i=n-_,r={startTime:_,length:i,bitrate:t/(i/1e3),index:p};0<p&&(k.length<100||k.shift(),k.push(r)),_=n,p+=1,o._pendingFetchMap.set(f,{bytesTotal:e.total,bytesLoaded:l=e.loaded,percent:e.loaded/e.total,identifier:u}),o.fire("progress",u)}}),f.open("GET",n,!0),f.responseType="arraybuffer",i&&f.setRequestHeader("Range","bytes="+i),f.onload=function(e){var t=Date.now()-s;f.data.duration=t,o._activeXhrRequests.delete(f),o._pendingFetchMap.delete(f);var n=(m.getTime()-c)/1e3,i=e.target.response.byteLength;if(40960<i){var r=8*i/n;100<g.length&&g.shift(),o._includeWithSpeeds&&h&&g.push(r)}o._handleXHRResponse(f,a,u,d),o._continueProcessingQueue()},f.onerror=function(){var e=Date.now()-s;f.data.duration=e,o._activeXhrRequests.delete(f),o._pendingFetchMap.delete(f),o._retry(f,a,u),o._continueProcessingQueue()},f.onabort=function(){var e=Date.now()-s;y.push({url:n,status:"abort",duration:f.data.duration=e}),o._pendingFetchMap.delete(f),o._activeXhrRequests.delete(f),o.fire("downloadabort",u),0===o._activeXhrRequests.size&&0===o._queue.length&&(o._processingQueue=!1),o._continueProcessingQueue()},this.fire("downloadstart",u),this._activeXhrRequests.add(f),s=Date.now(),f.send()}else this._processingQueue=!1}},{key:"parallel",get:function(){return this._parallel},set:function(e){this._parallel=e}},{key:"pendingFetches",get:function(){var t=this,n=[];return this._activeXhrRequests.forEach(function(e){t._pendingFetchMap.get(e)&&n.push(t._pendingFetchMap.get(e))}),n}}]),m}(),l=function(){function t(e){h(this,t),u(this),this._sorcerer=e,this._activeStreamIndex=this._sourceBuffer=null,this._needInitSegment=!(this._needsStreamSwitch=!1),this._lastAppended=null,this._toRemove=[],this._quotaExceeded=!(this._streams=[]),this._quotaExceededTimer=null,this._appendingFinalSegment=!1,this._finalSegmentTime=void 0,this._isFirstSegment=!(this._addingInitSegment=!1),this._bufferState={},this._sorcerer.on("durationset",this._onDurationSet.bind(this))}return c(t,[{key:"addStream",value:function(e){var t=this;e.on("segmentadd",function(){return t._process()});var n=this._streams.push(e)-1;e.index=n,null===this._activeStreamIndex&&(this._setActiveIndex(n),this._needsStreamSwitch=!0)}},{key:"streamIndexAtTime",value:function(e){return this._bufferState[void 0]?{stream:this.activeStreamIndex}:this._bufferState[Math.floor(e/6)]}},{key:"switchTo",value:function(e){var t=this,n=arguments.length<=1||void 0===arguments[1]||arguments[1],i=e;"object"===(void 0===e?"undefined":d(e))&&(i=e.index);var r=this._activeStreamIndex!==i,o=r;if(!r&&this._needsStreamSwitch&&(r=!0),r){this._needsStreamSwitch=!1;var s=this._streams[this._activeStreamIndex];s&&o&&n&&s.abort(),this._setActiveIndex(this._switchToIndex=i)}return this._process(),new Promise(function(e){r?t._resolveSwitchComplete=function(){t._switchToIndex===i&&(t._resolveSwitchComplete=null,e(),t.fire("streamchange",i))}:e()})}},{key:"isTimeInBuffer",value:function(e){for(var t=0;t<this.sourceBuffer.buffered.length;t++){var n=this.sourceBuffer.buffered.start(t),i=this.sourceBuffer.buffered.end(t);if(n<=e&&e<=i)return!0}return!1}},{key:"hasAppendedFinalSegment",value:function(){return void 0!==this._finalSegmentTime&&this.isTimeInBuffer(this._finalSegmentTime)}},{key:"clear",value:function(){this._streams.forEach(function(e){e.clear()})}},{key:"remove",value:function(n){var i=this,r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:this._sorcerer._mediaSource.duration;return new Promise(function(e,t){i._toRemove.push([n,r,e]),i._process()})}},{key:"_onDurationSet",value:function(){var e=this._sorcerer._mediaSource.duration,t=Math.floor(e/6);t+=1<6%e?1:0;for(var n=0;n<t;n++)this._bufferState[n]={stream:null,segment:n,type:"video"}}},{key:"_attachEvents",value:function(){var e=this;this.bound={handleUpdateEnd:this._handleUpdateEnd.bind(this)},this._sourceBuffer.addEventListener("updateend",this.bound.handleUpdateEnd),this._sorcerer.on("endofstream",function(){e._handleUpdateEnd()}),this._sorcerer.on("ended",this.bound.handleEnded)}},{key:"_handleUpdateEnd",value:function(e){this._appendingFinalSegment&&(this._finalSegmentTime=this._sourceBuffer.buffered.end(this._sourceBuffer.buffered.length-1),this._sorcerer._fireStreamHasEnded(),this._appendingFinalSegment=!1),this._lastAppended&&(this.fire("appendbufferend",this._lastAppended),this._lastAppended=null,this._resolveSwitchComplete&&this._resolveSwitchComplete()),this._process()}},{key:"_removeEventListeners",value:function(){this.bound&&(this._sourceBuffer&&this._sourceBuffer.removeEventListener("updateend",this.bound.handleUpdateEnd),this._sorcerer.off("endofstream",this.bound.handleUpdateEnd),this._sorcerer.off("ended",this.bound.handleEnded))}},{key:"_setActiveIndex",value:function(e){this._needInitSegment=!0,this._sorcerer._frameDropper.streamIndex=this._activeStreamIndex=e}},{key:"_process",value:function(){var t=this,n=this._streams[this._activeStreamIndex];if(this._sourceBuffer){if(n&&"closed"!==this._sorcerer._mediaSource.readyState){var i=this._sourceBuffer;if(!i.updating){if(this._toRemove.length){var e=this._toRemove.shift(),r=v(e,3),o=r[0],s=r[1],a=r[2],u=this;return i.addEventListener("updateend",function e(t){i.removeEventListener("updateend",e),a(),clearTimeout(u._quotaExceededTimer),u._quotaExceededTimer=setTimeout(function(){u._quotaExceeded=!1,u._process()},5e3)}),void i.remove(o,s)}if(!this._quotaExceeded&&!this._addingInitSegment){if(this._needInitSegment)return this._addingInitSegment=!0,n.getInitSegment().then(function(e){return t._lastAppended=null,i.appendBuffer(e),t._addingInitSegment=!1,e}).catch(function(e){console.error(e),t._addingInitSegment=!1}),void(this._needInitSegment=!1);var d=n.getNextSegment();if(null!==d){var h=n.getIdForSegment(d);n.isFinal(d)&&(this._appendingFinalSegment=!0),this.fire("appendbufferstart",this._lastAppended=h);try{i.appendBuffer(d),this._bufferState[h.segment]=h,this._isFirstSegment&&(this._isFirstSegment=!1,this.fire("initialbufferstart"))}catch(e){if("QuotaExceededError"===e.name){this._quotaExceeded=!0,console.warn("QuotaExceededError");if(6<this._sorcerer._video.currentTime){var c=this._sorcerer._video.currentTime-6;console.log("Removing buffer from 0 to "+c+"â€¦"),this._sorcerer.removeBuffer(0,c)}n._readyToAppend.unshift(d)}}}}}}}else this.on("sourcebufferattach",this._process)}},{key:"streams",get:function(){return this._streams}},{key:"activeStreamIndex",get:function(){return this._activeStreamIndex}},{key:"sourceBuffer",get:function(){return this._sourceBuffer},set:function(e){this._sourceBuffer=e,this._attachEvents(),this.fire("sourcebufferattach")}}]),t}(),p=function(){function l(n){var i=this,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"",t=2<arguments.length&&void 0!==arguments[2]?arguments[2]:new _;h(this,l),u(this),this._readyToAppend=[],this._initSegment=null,this._index=NaN,this._codec=e,this._fetcher=t,this._fetcher.start(),this._bufferData=new WeakMap,this._segmentToId={},this._getInitSegmentPromise=new Promise(function(t,e){l.isValidSegmentUrl(n)?i._fetcher.add({url:n.url||n,byteRange:n.byteRange,id:null,stream:i},function(e){t(i._initSegment=e)}):t(i._initSegment=n)})}return c(l,null,[{key:"isValidSegmentUrl",value:function(e){return"string"==typeof e||"string"==typeof e.url&&"string"==typeof e.byteRange}}]),c(l,[{key:"getIdForSegment",value:function(e){return l.isValidSegmentUrl(e)?this._segmentToId[e]:this._bufferData.get(e).id}},{key:"isFinal",value:function(e){return this._bufferData.get(e).final}},{key:"addSegment",value:function(n){var i=this,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},t=e.identifier,r=void 0===t?null:t,o=e.isFinalSegment,s=void 0!==o&&o,a=e.loadOnly,u=void 0!==a&&a,d=e.priority,h=void 0===d?0:d,c=e.includeWithBandwidthChecks,f=void 0===c||c;return new Promise(function(t,e){if(l.isValidSegmentUrl(n))return i._segmentToId[n]=r||n,i.fire("queued",i.getIdForSegment(n)),void i._fetcher.add({url:n.url||n,byteRange:n.byteRange,id:i.getIdForSegment(n),stream:i,includeWithBandwidthChecks:f,priority:h},function(e){i._bufferData.set(e,{id:r||n,final:s}),i._readyToAppend.push(e),i.fire("bufferqueueadd",i.getIdForSegment(n)),u||i.fire("segmentadd"),t()});i._bufferData.set(n,{id:r,final:s}),i._readyToAppend.push(n),i.fire("bufferqueueadd",r),t()})}},{key:"clear",value:function(){this._readyToAppend=[]}},{key:"abort",value:function(){var e=this;this._getInitSegmentPromise.then(function(){e._fetcher.abort(e)}).catch(function(e){console.error(e)})}},{key:"getNextSegment",value:function(){return 0===this._readyToAppend.length?null:this._readyToAppend.shift()}},{key:"getInitSegment",value:function(){return this._getInitSegmentPromise}},{key:"codec",get:function(){return this._codec},set:function(e){this._codec=e}},{key:"index",get:function(){return this._index},set:function(e){this._index=e}},{key:"pendingFetches",get:function(){return this._fetcher.pendingFetches}}]),l}(),m=function(){function t(e){h(this,t),this._video=e,this._running=!1,this._droppedFramesTimeout=null,this._droppedFrameData={},this._decodedFrameData={},this._decodedFrames=this._droppedFrames=0,this._streamIndex="default",this.bound={startCheckingDroppedFrames:this._startCheckingDroppedFrames.bind(this),stopCheckingDroppedFrames:this._stopCheckingDroppedFrames.bind(this)}}return c(t,[{key:"start",value:function(){return this._startCheckingDroppedFrames(),this}},{key:"stop",value:function(){return this._stopCheckingDroppedFrames(),this}},{key:"destroy",value:function(){this._stopCheckingDroppedFrames(),this._removeEvents()}},{key:"getDroppedFrameRate",value:function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"average",i=this._droppedFrameData[t];if(!i)return 0;if(i.length<e)return 0;var r=i.slice(-e);return"median"===n?s(r):a(r)}},{key:"getDroppedFrameTotal",value:function(){return{dropped:this._getTotalDroppedFrames(),total:this._getTotalFrames()}}},{key:"_attachEvents",value:function(){this._video.addEventListener("playing",this.bound.startCheckingDroppedFrames),this._video.addEventListener("pause",this.bound.stopCheckingDroppedFrames),this._video.addEventListener("ended",this.bound.stopCheckingDroppedFrames)}},{key:"_removeEvents",value:function(){this._video.removeEventListener("playing",this.bound.startCheckingDroppedFrames),this._video.removeEventListener("pause",this.bound.stopCheckingDroppedFrames),this._video.removeEventListener("ended",this.bound.stopCheckingDroppedFrames)}},{key:"_startCheckingDroppedFrames",value:function(){this._running=!0,this._checkDroppedFrames()}},{key:"_stopCheckingDroppedFrames",value:function(){this._running=!1}},{key:"_checkDroppedFrames",value:function(){var e=this;if(this._running&&null!==this._streamIndex){clearTimeout(this._droppedFramesTimeout);var t=this._getTotalDroppedFrames(),n=t-this._droppedFrames;this._droppedFrames=t;var i=this._getTotalDecodedFrames(),r=i-this._decodedFrames;this._decodedFrames=i,this._droppedFrameData[this._streamIndex]||(this._droppedFrameData[this._streamIndex]=[]),this._decodedFrameData[this._streamIndex]||(this._decodedFrameData[this._streamIndex]=[]),100<this._droppedFrameData[this._streamIndex].length&&this._droppedFrameData[this._streamIndex].shift(),100<this._decodedFrameData[this._streamIndex].length&&this._decodedFrameData[this._streamIndex].shift(),this._droppedFrameData[this._streamIndex].push(n),this._decodedFrameData[this._streamIndex].push(r),this._droppedFramesTimeout=setTimeout(function(){e._checkDroppedFrames()},1e3)}}},{key:"_getTotalDroppedFrames",value:function(){return"function"==typeof this._video.getVideoPlaybackQuality?this._video.getVideoPlaybackQuality().droppedVideoFrames:this._video.webkitDroppedFrameCount||0}},{key:"_getTotalFrames",value:function(){return"function"==typeof this._video.getVideoPlaybackQuality?this._video.getVideoPlaybackQuality().totalVideoFrames:this._video.webkitDecodedFrameCount||0}},{key:"_getTotalDecodedFrames",value:function(){if("function"==typeof this._video.getVideoPlaybackQuality){var e=this._video.getVideoPlaybackQuality();return e.totalVideoFrames-e.droppedVideoFrames-e.corruptedVideoFrames}return this._video.webkitDecodedFrameCount||0}},{key:"streamIndex",get:function(){return this._streamIndex},set:function(e){this._streamIndex=e}}]),t}(),n=function(){function n(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};h(this,n),this._video=e,this._options=t,u(this),this._options.duration&&(this._options.duration=Math.ceil(100*this._options.duration)/100),this._bufferCount=0,this._frameDropper=new m(e),this._mediaSource=new MediaSource,this._fetcher=new _({parallel:1}),this._video.src=URL.createObjectURL(this._mediaSource),this._buffersForCodec={},this._readyPromiseResolve=null,this._attachEvents()}return c(n,[{key:"switchTo",value:function(e){return 1===this._bufferCount?this.video.switchTo(e):(console.error("The switch method on MediaSorcerer only works with single streams"),!1)}},{key:"getCurrentSpeed",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.type,n=void 0===t?"average":t,i=e.howMany,r=void 0===i?10:i,o=e.weights,s=e.percentile,a=void 0===s?null:s;return"average"===n?_.getAverageSpeed(r,void 0===o?[]:o):"median"===n?_.getMedianSpeed(r):_.getPercentileSpeed(r,a)}},{key:"getAverageDownloadBitrate",value:function(){return _.getAverageBitrate(0<arguments.length&&void 0!==arguments[0]?arguments[0]:1e3)}},{key:"getResponseSpeeds",value:function(){return _.getResponseSpeeds()}},{key:"getFailedSegments",value:function(){return _.getFailedSegments()}},{key:"getSuccessfulSegments",value:function(){return _.getSuccessfulSegments()}},{key:"getDroppedFrameRate",value:function(e){return this._frameDropper.getDroppedFrameRate(e,1<arguments.length&&void 0!==arguments[1]?arguments[1]:this.activeStreamIndex,2<arguments.length&&void 0!==arguments[2]?arguments[2]:"average")}},{key:"getDroppedFrameTotal",value:function(){return this._frameDropper.getDroppedFrameTotal()}},{key:"clear",value:function(){for(var e in this._buffersForCodec)this._buffersForCodec[e].clear()}},{key:"streamIndexAtTime",value:function(e,t){return this._buffersForCodec[t].streamIndexAtTime(e)?this._buffersForCodec[t].streamIndexAtTime(e).stream:null}},{key:"removeBuffer",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:this._video.duration;if(t<e)return Promise.resolve();var n=[];for(var i in this._buffersForCodec)n.push(this._buffersForCodec[i].remove(e,t));return Promise.all(n)}},{key:"addStream",value:function(e,t){var n=this,i=this._getCodecType(e);if(!this._buffersForCodec[i]){this._bufferCount+=1;var r=new l(this,i);this._buffersForCodec[i]=r,this.readyPromise.then(function(){var t=void 0;try{t=n._mediaSource.addSourceBuffer(e)}catch(e){if(22!==e.code)return console.error(e),void n.fire("srcnotsupported",e);t=n._buffersForCodec[i]}n._options.duration&&(t.appendWindowEnd=n._options.duration),r.sourceBuffer=t}).catch(function(e){console.error(e)}),["appendbufferstart","appendbufferend","streamchange","initialbufferstart"].forEach(function(t){r.on(t,function(e){n.fire(t,e)})})}var o=new p(t,e,this._fetcher);return["queued","bufferqueueadd"].forEach(function(t){o.on(t,function(e){n.fire(t,e)})}),this._buffersForCodec[i].addStream(o),o}},{key:"destroy",value:function(){this.clear(),this._removeEventListeners(),this._frameDropper.destroy(),this._fetcher.abort(),this._video.src&&URL.revokeObjectURL(this._video.src)}},{key:"_attachEvents",value:function(){var r=this;this.bound={handleSourceOpen:this._handleSourceOpen.bind(this)},this.readyPromise=new Promise(function(e,t){r._readyPromiseResolve=e,r._mediaSource.addEventListener("sourceopen",r.bound.handleSourceOpen)}),["downloadstart","downloadend","downloadabort","downloaderror","progress"].forEach(function(i){r._fetcher.on(i,function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];r.fire.apply(r,[i].concat(t))})})}},{key:"_sourceBuffersAreUpdating",value:function(){for(var e=0;e<this._mediaSource.sourceBuffers.length;e++)if(this._mediaSource.sourceBuffers[e].updating)return!0;return!1}},{key:"_fireStreamHasEnded",value:function(){for(var e in this._buffersForCodec){if(!this._buffersForCodec[e].hasAppendedFinalSegment())return}"open"===this._mediaSource.readyState&&(this._sourceBuffersAreUpdating()||(console.log("Firing MediaSource.endOfStream()"),this._mediaSource.endOfStream(),this.fire("endofstream")))}},{key:"_handleSourceOpen",value:function(){this._options.duration&&(this._mediaSource.duration=this._options.duration,this.fire("durationset")),this._readyPromiseResolve(),this._mediaSource.removeEventListener("sourceopen",this.bound.handleSourceOpen)}},{key:"_removeEventListeners",value:function(){for(var e in this._buffersForCodec)this._buffersForCodec[e]._removeEventListeners()}},{key:"_getCodecType",value:function(e){return 0===e.indexOf("audio")?"audio":"video"}},{key:"mediaSource",get:function(){return this._mediaSource}},{key:"streams",get:function(){return 1===this._bufferCount?this.video.streams:(console.error("The streams property on MediaSorcerer only works with single streams"),!1)}},{key:"activeStreamIndex",get:function(){return 1===this._bufferCount?this.video.activeStreamIndex:(console.error("The activeStreamIndex property on MediaSorcerer only works with single streams"),!1)}},{key:"video",get:function(){return this._buffersForCodec.video?this._buffersForCodec.video:(console.error("No video streams have been added to MediaSorcerer"),!1)}},{key:"audio",get:function(){return this._buffersForCodec.audio?this._buffersForCodec.audio:(console.error("No audio streams have been added to MediaSorcerer"),!1)}}]),n}(),S=function(){function t(e){r(this,t),this._audioEl=e,this._files=null,this._sorcerer=new n(this._audioEl)}return e(t,[{key:"play",value:function(){this._audioEl.paused&&this._audioEl.play()}},{key:"initPlayback",value:function(){this.play(),this._appendSegments()}},{key:"_appendSegments",value:function(){var t=this;this._files.slice(1).forEach(function(e){t._audioStream.addSegment("../chunk2/".concat(e)),console.log(t._sorcerer._buffersForCodec.audio)}),console.log("Done appending"),this._sorcerer._fireStreamHasEnded()}},{key:"source",set:function(e){this._files=e,this._audioStream=this._sorcerer.addStream("audio/mpeg","../chunk2/".concat(this._files[0]))}},{key:"playbackRate",get:function(){return this._audioEl.playbackRate},set:function(e){this._audioEl.playbackRate=e}},{key:"muted",get:function(){return this._audio.muted},set:function(e){this._audioEl.muted=e}}]),t}(),b=function(){function t(e){r(this,t),this._audioEl=e}return e(t,[{key:"initPlayback",value:function(){this.play()}},{key:"play",value:function(){this._audioEl.paused&&this._audioEl.play()}},{key:"pause",value:function(){this._audioEl.pause()}},{key:"currentTime",get:function(){return this._audioEl.currentTime},set:function(e){this._audioEl.currentTime=e}},{key:"duration",get:function(){return this._audioEl.duration}},{key:"source",get:function(){return this._audioEl.src},set:function(e){this._audioEl.src=e[0]}},{key:"playbackRate",get:function(){return this._audioEl.playbackRate},set:function(e){this._audioEl.playbackRate=e}},{key:"muted",get:function(){return this._audio.muted},set:function(e){this._audioEl.muted=e}}]),t}();return function(){function n(e,t){if(r(this,n),this._audioEl=e,this._files=t,1<this._files.length&&(this.engine=new S(this._audioEl)),1!==this._files.length)throw Error("No file");this.engine=new b(this._audioEl),this.engine.source=this._files;this.analyser=new o(this._audioEl,{smoothingTimeConstant:0,fftSize:512})}return e(n,[{key:"initPlayback",value:function(){this.engine.initPlayback()}},{key:"playbackRate",get:function(){return this.engine.playbackRate},set:function(e){this.engine.playbackRate=e}},{key:"muted",get:function(){return this.engine.muted},set:function(e){this.engine.muted=e}}]),n}()});
