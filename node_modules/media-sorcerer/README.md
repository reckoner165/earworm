# Media Sorcerer

Media sorcerer is a low-level wrapper around the [MediaSource API](https://w3c.github.io/media-source/). The goal of the project is to simplify the API and make things easier to use than the native browser API.

This repo requires pull-request reviews for all changes on branches bound for production. For more information see [Github: Pull Request Policy](https://github.vimeows.com/Vimeo/vimeo/wiki/Github%3A-Pull-Request-Policy).

## Basic Usage Example

This is a very simple look at how you would load and playback some SD segments then switch to 720p during playback.

```javascript
const video = document.querySelector('video');
const mediaSorcerer = new MediaSorcerer(video, { duration: 60 });

const sdStream = mediaSorcerer.addStream('video/mp4; codecs="avc1.64001F"', 'https://example.com/360p/init-segment.mp4');
const hdStream720 = mediaSorcerer.addStream('video/mp4; codecs="avc1.64001F"', 'https://example.com/720p/init-segment.mp4');
const hdStream1080 = mediaSorcerer.addStream('video/mp4; codecs="avc1.640028"', 'https://example.com/1080p/init-segment.mp4');

sdStream.addSegment('https://example.com/360p/segment-1.m4s');
sdStream.addSegment('https://example.com/360p/segment-2.m4s');
sdStream.addSegment('https://example.com/360p/segment-3.m4s');

video.play();

// After some time has passed…
hdStream720.addSegment('https://example.com/720p/segment-4.m4s');
hdStream720.addSegment('https://example.com/720p/segment-5.m4s');
hdStream720.addSegment('https://example.com/720p/segment-6.m4s');
mediaSorcerer.switchTo(hdStream720);
```

Media sorcerer fetches and appends the segments to the buffer for you and keeps track of metrics such as the connection speed of the viewer and the number of dropped frames for a given stream.

It also introduces the concept of video streams independent of buffers which makes it possible to do things like load segments of a stream before switching to it.

## Architecture

The structure looks something like this:

- [MediaSorcerer](#mediasorcerer)
    - [FrameDropper](#framedropper)
    - [Buffer](#buffer)
        - [Stream](#stream)
            - [Fetcher](#fetcher)

### MediaSorcerer

The MediaSorcerer object is the primary way to interact with the video for handling playback using the MediaSource API.

- [constructor](#constructor)
- [addStream](#addstream)
- [clear](#clear)
- [destroy](#destroy)
- [getCurrentSpeed](#getcurrentspeed)
- [getDroppedFrameRate](#getdroppedframerate)
- [getDroppedFrameTotal](#getdroppedframetotal)
- [getResponseSpeeds](#getresponsespeeds)
- [removeBuffer](#removebuffer)
- [switchTo](#switchto)

#### properties

| name | type | description |
| --- | --- | --- |
| mediaSource | `MediaSource` | A reference to the actual MediaSource object being used for playback |
| video | `Buffer` or `false` | A reference to the video buffer object or `false` if there is no video buffer |
| audio | `Buffer` or `false` | A reference to the audio buffer object or `false` if there is no audio buffer |
| streams | `Array` or `false` | A shortcut for accessing `Stream` objects when there is a single (video) buffer |
| activeStreamIndex | `Number` or `false` | A shortcut for accessing the currently active stream index when there is a single (video) buffer |

#### methods

##### constructor

Creates a new MediaSorcerer object

```javascript
const options = { duration: 123 };
new MediaSorcerer(video, options);
```

- Arguments

    | name | description |
    | --- | --- |
    | video | A reference to the video tag element on the page that you want to use MediaSource with |
    | options | Options for MediaSorcerer. Currently the only supported option is the video duration |

##### addStream

Creates a new `Stream` object and adds it to the corresponding `Buffer` object.

```javascript
const sdStream = mediaSorcerer.addStream('video/mp4; codecs="avc1.64001F"', 'https://example.com/360p/init-segment.mp4');
```

- Arguments

    | name | description |
    | --- | --- |
    | codec | The codec string corresponding to the stream you are creating |
    | initSegment | A URL or `ArrayBuffer` object representing the init segment for this stream |

- Returns

    This method returns a `Stream` object.

##### clear

Clears out all buffers that are currently in the queue to be appended across all buffers and streams.

##### destroy

Destroys the MediaSorcerer instance and removes all event listeners.

##### getCurrentSpeed

Gets the current download speed for the viewer in bps (bits per second).

```javascript
// This will provide a weighted average where the most recent speed is weighted higher than the previous speeds
const speed = mediaSorcerer.getCurrentSpeed({ type: 'average', howMany: 3, weights: [1, 2, 5]});
```

- Arguments

    | name | description |
    | --- | --- |
    | options | An object containing options |

    Available options are

    | name | description | default |
    | --- | --- | --- |
    | type | The way to calculate the speed (“average”, “median”, or “percentile”) | `average` |
    | howMany | The number of recent speeds to include when doing the calculation. | `10` |
    | weights | An array of weights to use to calculate a weighted average. | `[]` |
    | percentile | The percentile to use from 0 to 1 if you want a percentile speed | `null` |

##### getDroppedFrameRate

Returns the rate of dropped frames over the last x number of seconds.

- Arguments

    | name | description | default |
    | --- | --- | --- |
    | howMany | Number of seconds to look at | undefined |
    | streamIndex | Which stream to check | The current video activeStreamIndex |
    | type | How to calculate the number of dropped frames (“average”, or “median”) | `average` |

##### getDroppedFrameTotal

Returns the total number of dropped frames throughout the entire playback session.

##### getResponseSpeeds

Returns an array of (up to) the last 100 raw response speeds (in bits per second) in case you want to use them in a way that `getCurrentSpeed` will provide.

##### removeBuffer

Calls `Buffer.remove` on each Buffer object that has been created.

##### switchTo

A shortcut for calling `Buffer.switchTo` when there is only a single (video) buffer

### Buffer

The Buffer object is a wrapper around the native SourceBuffer object. It queries streams to get what segments to append to the buffer and handles switching between streams.

- [addStream](#addstream-1)
- [clear](#clear-1)
- [remove](#remove)
- [switchTo](#switchto-1)

#### properties

| name | type | description |
| --- | --- | --- |
| streams | `Array` | An array of stream objects that correspond to this buffer |
| activeStreamIndex | `Number` or `null` | The index of the active stream that is playing back |
| sourceBuffer | `SourceBuffer` | A reference to the actual `SourceBuffer` object in the browser |

#### methods

##### addStream

Adds a stream object to this buffer

- Arguments

    | name | description |
    | --- | --- |
    | stream | A `Stream` object |

##### clear

Clears out all segments in the queue for all streams belonging to this buffer

##### remove

Removes a section of the buffer

```javascript
// Remove the video buffer from 10 to 20 seconds
mediaSorcerer.video.remove(10, 20);
```

- Arguments

| name | description | default |
| --- | --- | --- |
| startTime | The time in the buffer we should start at | `undefined` |
| endTime | The time in the buffer we should end at | `MediaSource.duration` |

##### switchTo

Switches the currently active stream to the specified stream or stream index

- Arguments

    | name | description |
    | --- | --- |
    | stream | A `Stream` object or numeric index of which stream to switch to |

- Returns

    This method returns a `Promise` that will resolve when the first segment of the new stream has been appended to the buffer.

### Stream

The Stream object is a representation of a specific quality of audio or video.

#### properties

| name | type | description |
| --- | --- | --- |
| codec | `string` | The codec string originally passed in when creating the stream with `MediaSorcerer.addStream` |
| index | `Number` | The numeric index of this stream inside of the `Buffer.streams` array |

#### methods

##### constructor

Creates a Stream object

- Arguments

    | name | description |
    | --- | --- |
    | initSegment | A URL or ArrayBuffer representing the init segment for this stream |
